name: Build, Test, and Deploy to Kubernetes on EC2 (Full Setup)

on:
  push:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn clean package -DskipTests

      - name: Build Docker Image
        run: docker build -t welcomeapi:latest .

      - name: Save Docker Image as tar
        run: docker save welcomeapi:latest -o welcomeapi.tar

      - name: Create deploy script for remote execution
        run: |
          cat > deploy.sh <<'REMOTE_SCRIPT'
          #!/usr/bin/env bash
          set -euo pipefail
          echo "===== âš™ï¸ Starting Kubernetes Setup on EC2 ====="

          sudo swapoff -a
          sudo sed -i '/swap/d' /etc/fstab

          echo "===== ðŸ§© Installing Docker and Kubernetes ====="
          sudo yum update -y
          sudo yum remove -y curl-minimal || true
          sudo yum install -y --allowerasing docker git wget curl
          sudo systemctl enable --now docker

          if ! command -v kubeadm &> /dev/null; then
            cat <<EOR | sudo tee /etc/yum.repos.d/kubernetes.repo
          [kubernetes]
          name=Kubernetes
          baseurl=https://pkgs.k8s.io/core:/stable:/v1.30/rpm/
          enabled=1
          gpgcheck=0
          repo_gpgcheck=0
          EOR
            sudo yum install -y kubelet kubeadm kubectl
            sudo systemctl enable --now kubelet
          fi

          echo "===== ðŸš€ Initializing Kubernetes Cluster ====="
          sudo kubeadm reset -f || true
          sudo rm -rf ~/.kube || true
          sudo kubeadm init --pod-network-cidr=192.168.0.0/16 --ignore-preflight-errors=NumCPU,Mem

          mkdir -p ~/.kube
          sudo cp -f /etc/kubernetes/admin.conf ~/.kube/config
          sudo chown $(id -u):$(id -g) ~/.kube/config

          echo "===== ðŸŒ Installing Calico CNI ====="
          kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml

          echo "Waiting for Calico pods to be Ready..."
          sleep 90
          kubectl get pods -n kube-system || true

          echo "===== ðŸ³ Loading Docker Image into Node ====="
          sudo docker load -i /home/ec2-user/welcomeapi.tar || true

          echo "===== ðŸ“¦ Deploying Welcome API ====="
          kubectl apply -f /home/ec2-user/k8s-deployment.yaml

          echo "===== â³ Waiting for Pods to be Ready ====="
          kubectl wait --for=condition=Ready pods --all --timeout=180s || true

          echo "===== âœ… Deployment Summary ====="
          kubectl get pods -o wide || true
          kubectl get svc -o wide || true
          kubectl get nodes -o wide || true

          echo "===== ðŸŽ‰ Kubernetes Deployment Completed Successfully ====="
          REMOTE_SCRIPT
          chmod +x deploy.sh

      - name: Transfer files to EC2
        env:
          HOST: ${{ secrets.K8S_MASTER_HOST }}
          KEY: ${{ secrets.K8S_MASTER_KEY }}
        run: |
          echo "$KEY" > key.pem
          chmod 600 key.pem
          scp -o StrictHostKeyChecking=no -i key.pem welcomeapi.tar ec2-user@$HOST:/home/ec2-user/
          scp -o StrictHostKeyChecking=no -i key.pem k8s-deployment.yaml ec2-user@$HOST:/home/ec2-user/
          scp -o StrictHostKeyChecking=no -i key.pem deploy.sh ec2-user@$HOST:/home/ec2-user/

      - name: Run deploy script on EC2
        env:
          HOST: ${{ secrets.K8S_MASTER_HOST }}
          KEY: ${{ secrets.K8S_MASTER_KEY }}
        run: |
          echo "$KEY" > key.pem
          chmod 600 key.pem
          ssh -o StrictHostKeyChecking=no -i key.pem ec2-user@$HOST "bash /home/ec2-user/deploy.sh"
EOF
