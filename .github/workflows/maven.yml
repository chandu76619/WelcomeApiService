name: Build, Test, and Deploy to Kubernetes on EC2 (Full Setup)

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # -----------------------------
    # Step 1: Checkout Code
    # -----------------------------
    - name: Checkout Repository
      uses: actions/checkout@v4

    # -----------------------------
    # Step 2: Setup Java
    # -----------------------------
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    # -----------------------------
    # Step 3: Build App with Maven
    # -----------------------------
    - name: Clean and Build with Maven
      run: |
        mvn clean package -DskipTests

    # -----------------------------
    # Step 4: Build Docker Image
    # -----------------------------
    - name: Build Docker Image
      run: docker build -t welcomeapi:latest .

    # -----------------------------
    # Step 5: Save Docker Image
    # -----------------------------
    - name: Save Docker Image as tar
      run: docker save welcomeapi:latest -o welcomeapi.tar

    # -----------------------------
    # Step 6: Transfer Image & YAML to EC2
    # -----------------------------
    - name: Transfer Image and YAML to EC2
      env:
        HOST: ${{ secrets.K8S_MASTER_HOST }}
        KEY: ${{ secrets.K8S_MASTER_KEY }}
      run: |
        echo "$KEY" > key.pem
        chmod 600 key.pem
        scp -o StrictHostKeyChecking=no -i key.pem welcomeapi.tar ec2-user@$HOST:/home/ec2-user/
        scp -o StrictHostKeyChecking=no -i key.pem k8s-deployment.yaml ec2-user@$HOST:/home/ec2-user/

    # -----------------------------
    # Step 7: Install Kubernetes & Deploy
    # -----------------------------
    - name: Install Kubernetes and Deploy
      env:
        HOST: ${{ secrets.K8S_MASTER_HOST }}
        KEY: ${{ secrets.K8S_MASTER_KEY }}
      run: |
        echo "$KEY" > key.pem
        chmod 600 key.pem

        ssh -o StrictHostKeyChecking=no -i key.pem ec2-user@$HOST << 'EOF'
        set -e
        echo "===== ‚öôÔ∏è Starting Kubernetes Setup on EC2 (Amazon Linux 2023) ====="

        # -----------------------------
        # Step 1: Install Dependencies
        # -----------------------------
        echo "===== üß© Installing Docker and Tools ====="
        sudo dnf update -y
        sudo dnf install -y docker git wget curl conntrack socat ebtables iproute-tc

        sudo systemctl enable docker
        sudo systemctl start docker

        # Disable swap (required for kubeadm)
        sudo swapoff -a
        sudo sed -i '/swap/d' /etc/fstab

        # -----------------------------
        # Step 2: Install Kubernetes Binaries
        # -----------------------------
        echo "===== üì¶ Installing kubeadm, kubectl, kubelet manually ====="
        K8S_VERSION="v1.30.0"
        cd /usr/local/bin

        sudo curl -L --remote-name-all https://dl.k8s.io/release/${K8S_VERSION}/bin/linux/amd64/{kubeadm,kubelet,kubectl}
        sudo chmod +x kubeadm kubelet kubectl
        sudo systemctl enable kubelet

        # Setup kubelet service (if missing)
        if [ ! -f /etc/systemd/system/kubelet.service ]; then
          sudo bash -c 'cat <<EOF2 > /etc/systemd/system/kubelet.service
[Unit]
Description=kubelet: The Kubernetes Node Agent
Documentation=https://kubernetes.io/docs/home/
After=network-online.target

[Service]
ExecStart=/usr/local/bin/kubelet
Restart=always
StartLimitInterval=0
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF2'
          sudo systemctl daemon-reload
        fi

        echo "===== ‚úÖ Kubernetes binaries installed ====="
        kubeadm version
        kubectl version --client
        kubelet --version

        # -----------------------------
        # Step 3: Initialize Cluster
        # -----------------------------
        if [ ! -f /etc/kubernetes/admin.conf ]; then
          echo "Initializing Kubernetes Cluster..."
          sudo kubeadm reset -f || true
          sudo kubeadm init --pod-network-cidr=192.168.0.0/16

          mkdir -p \$HOME/.kube
          sudo cp -i /etc/kubernetes/admin.conf \$HOME/.kube/config
          sudo chown \$(id -u):\$(id -g) \$HOME/.kube/config

          echo "Installing Calico CNI..."
          kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.27.2/manifests/calico.yaml

          echo "Waiting 60s for Calico to start..."
          sleep 60
        else
          echo "Kubernetes already initialized. Refreshing kubeconfig..."
          mkdir -p \$HOME/.kube
          sudo cp -i /etc/kubernetes/admin.conf \$HOME/.kube/config
          sudo chown \$(id -u):\$(id -g) \$HOME/.kube/config
        fi

        echo "===== ‚úÖ Cluster is Ready ====="
        kubectl get nodes -o wide

        # -----------------------------
        # Step 4: Load and Deploy App
        # -----------------------------
        echo "===== üê≥ Loading Docker Image ====="
        sudo docker load -i /home/ec2-user/welcomeapi.tar

        echo "===== üì¶ Deploying Application ====="
        kubectl apply -f /home/ec2-user/k8s-deployment.yaml

        echo "===== ‚è≥ Waiting for Deployment ====="
        kubectl rollout status deployment/welcomeapi-deployment --timeout=180s || true

        echo "===== ‚úÖ Deployment Summary ====="
        kubectl get pods -o wide
        kubectl get svc welcomeapi-service

        echo "===== üéâ Deployment Complete! ====="
        EOF
