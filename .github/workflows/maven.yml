name: Build, Test, and Deploy to Kubernetes on EC2 (Full Setup)

on:
  push:
    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ðŸ§© Step 1: Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v4

      # ðŸ§© Step 2: Setup JDK 17
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      # ðŸ§© Step 3: Build with Maven
      - name: Clean and Build with Maven
        run: mvn clean package -DskipTests

      # ðŸ§© Step 4: Build Docker Image
      - name: Build Docker Image
        run: docker build -t welcomeapi:latest .

      # ðŸ§© Step 5: Save Docker Image as .tar
      - name: Save Docker Image
        run: docker save welcomeapi:latest -o welcomeapi.tar

      # ðŸ§© Step 6: Transfer Files to EC2
      - name: Transfer Image and YAML to EC2
        env:
          HOST: ${{ secrets.K8S_MASTER_HOST }}
          KEY: ${{ secrets.K8S_MASTER_KEY }}
        run: |
          echo "$KEY" > key.pem
          chmod 600 key.pem
          scp -o StrictHostKeyChecking=no -i key.pem welcomeapi.tar ec2-user@$HOST:/home/ec2-user/
          scp -o StrictHostKeyChecking=no -i key.pem k8s-deployment.yaml ec2-user@$HOST:/home/ec2-user/

      # ðŸ§© Step 7: Install Kubernetes (if needed) and Deploy
      - name: Install Kubernetes and Deploy Application
        env:
          HOST: ${{ secrets.K8S_MASTER_HOST }}
          KEY: ${{ secrets.K8S_MASTER_KEY }}
        run: |
          echo "$KEY" > key.pem
          chmod 600 key.pem

          ssh -o StrictHostKeyChecking=no -i key.pem ec2-user@$HOST << 'EOF'
          set -e
          echo "===== âš™ï¸ Starting Kubernetes Setup on EC2 ====="

          # Step 1: Docker setup
          echo "===== ðŸ§© Installing Docker ====="
          sudo yum install -y docker git wget
          sudo systemctl enable docker --now

          # Step 2: Disable swap (k8s requirement)
          sudo swapoff -a
          sudo sed -i '/swap/d' /etc/fstab

          # Step 3: Install Kubernetes if not installed
          if ! command -v kubeadm &> /dev/null
          then
            echo "Installing Kubernetes..."
            cat <<EOF2 | sudo tee /etc/yum.repos.d/kubernetes.repo
          [kubernetes]
          name=Kubernetes
          baseurl=https://packages.cloud.google.com/yum/repos/kubernetes-el7-\$basearch
          enabled=1
          gpgcheck=0
          repo_gpgcheck=0
          EOF2
            sudo yum install -y kubelet kubeadm kubectl
            sudo systemctl enable kubelet
          fi

          # Step 4: Initialize cluster if not already done
          if [ ! -f /etc/kubernetes/admin.conf ]; then
            echo "Initializing Kubernetes cluster..."
            sudo kubeadm reset -f || true
            sudo systemctl restart kubelet
            sudo systemctl restart docker
            sudo kubeadm init --pod-network-cidr=192.168.0.0/16

            mkdir -p \$HOME/.kube
            sudo cp -i /etc/kubernetes/admin.conf \$HOME/.kube/config
            sudo chown \$(id -u):\$(id -g) \$HOME/.kube/config

            echo "Installing Calico network..."
            kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml
          else
            echo "Kubernetes already initialized, reloading kubeconfig..."
            mkdir -p \$HOME/.kube
            sudo cp -i /etc/kubernetes/admin.conf \$HOME/.kube/config
            sudo chown \$(id -u):\$(id -g) \$HOME/.kube/config
          fi

          echo "===== âœ… Kubernetes Ready ====="
          kubectl get nodes -o wide

          # Step 5: Load and Deploy app
          echo "===== ðŸ³ Loading Docker Image ====="
          sudo docker load -i /home/ec2-user/welcomeapi.tar

          echo "===== ðŸ“¦ Deploying Application ====="
          kubectl apply -f /home/ec2-user/k8s-deployment.yaml

          echo "===== â³ Waiting for Rollout ====="
          kubectl rollout status deployment/welcomeapi-deployment --timeout=120s || true

          echo "===== âœ… Current Pods ====="
          kubectl get pods -o wide
          kubectl get svc welcomeapi-service

          echo "===== ðŸŽ‰ Deployment Complete ====="
          EOF
